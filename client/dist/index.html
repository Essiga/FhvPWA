<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="output.css">
    <link rel="manifest" href="app.webmanifest">
    <title>Title</title>
</head>
<body class="overflow-hidden">

<aside id="default-sidebar"
       class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0"
       aria-label="Sidebar">
    <div class="h-full px-3 py-4 overflow-y-auto bg-gray-950 dark:bg-gray-800">
        <div class="grid grid-cols-1 divide-y" >
            <div class="flex items-center justify-center">
                <select onchange="userChanged()" class="rounded-md px-1 mt-2 mb-4 bg-slate-800 text-amber-50" name="userSelection" id="userSelection">
                    <option>None</option>
                </select>
            </div>
            <div></div>
        </div>
        <ul id="conversationList" class="text-amber-50"></ul>
    </div>
</aside>


<div class="min-h-screen flex flex-col">
    <header>
        <nav class="bg-gray-950  px-4 py-8 lg:px-6">

        </nav>
    </header>
    <div class="p-4 sm:ml-64 h-screen bg-slate-900 text-amber-50 overflow-y-auto flex-grow">

        <div>test</div>
        <div>test</div>
        <div>test</div>    <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>    <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>    <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>    <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>        <div>test</div>
        <div>test</div>
        <div>test</div>    <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
        <div>test</div>
    </div>

</div>


</body>
</html>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("/sw.js");
    }


    let loggedInUser;
    function userChanged(){
        const conversationList = document.getElementById("conversationList");
        conversationList.innerHTML = '';
        const userSelection = document.getElementById("userSelection");
        console.log(JSON.parse(userSelection.value).fullname)
        loggedInUser = JSON.parse(userSelection.value).username
        loadConversationsForUser(JSON.parse(userSelection.value).username)
    }

    async function loadConversationsForUser(username){
        const response = await fetch("/conversations");
        const conversations = await response.json();
        console.log(conversations);

        conversations.forEach((conversation) => {
            if(username === conversation.participants[0] || username === conversation.participants[1]){
                addConversationToSideBar(conversation);
            }
        })
    }

    async function addConversationToSideBar(conversation){
        const response = await fetch("/users");
        const users = await response.json();

        users.forEach((user) => {
            if(user.username === conversation.participants[0] || user.username === conversation.participants[1] ){
                if(user.username !== loggedInUser){
                    let conversationList = document.getElementById("conversationList");
                    const listItem = document.createElement("div");
                    listItem.classList.add("p-4", "shadow-md", "flex", "items-center", "hover:bg-gray-800", "rounded-sm");

                    const avatar = document.createElement('div');
                    avatar.classList.add("avatar");

                    const avatarImage = document.createElement("div");
                    avatarImage.classList.add("w-12", "rounded-full", "mr-4");
                    avatarImage.innerHTML = `<img src="${user.image}" alt="${user.fullname}'s profile picture" />`;

                    const fullName = document.createElement("p");
                    fullName.textContent = user.fullname;
                    fullName.classList.add("text-center", "font-semibold");

                    avatar.appendChild(avatarImage);
                    listItem.appendChild(avatar);
                    listItem.appendChild(fullName);

                    conversationList.appendChild(listItem);
                }

            }
        })
    }

    async function getUserData() {
        const response = await fetch("/users");
        const users = await response.json();
        console.log(users);
        //let usersList = document.getElementById("usersList");
        // for(i = 0; i < users.length; i++){
        //     let li = document.createElement('li');
        //     //li.innerText = users[i].fullname;
        //     li.classList.add("flex", "items-center");
        //
        //     const avatar = document.createElement('div');
        //     avatar.classList.add("avatar");
        //
        //     const div = document.createElement('div');
        //     div.classList.add("w-12", "rounded-full");
        //     div.innerHTML = `<img src="${users[i].image}" alt="${users[i].fullname}'s profile picture" />`;
        //
        //     const contentContainer = document.createElement("div");
        //     contentContainer.classList.add("flex-1");
        //
        //     const fullName = document.createElement("p");
        //     fullName.textContent = users[i].fullname;
        //     fullName.classList.add("text-center");
        //
        //     contentContainer.appendChild(fullName);
        //     //li.appendChild(avatar)
        //     li.appendChild(contentContainer)
        //
        //     avatar.appendChild(div);
        //     usersList.appendChild(avatar);
        //     usersList.appendChild(fullName);
        //
        // }
        users.forEach((user) => {

            const userSelection = document.getElementById("userSelection");

            const option = document.createElement("option");
            option.text = user.fullname;
            option.value = JSON.stringify(user);
            userSelection.appendChild(option);


        });
    }

    getUserData()
</script>